## 第七章 跨程序共享数据——探究内容提供器

&emsp;&emsp;在上一章的持久化技术所保存的数据都只能在当前应用程序中访问。虽然文件和SharedPreferences存储中提供了MODE_WORLD_READABLE和MODE_WORLD_WRITEABLE这两种操作模式，用于供给其他的应用程序访问当前应用的程序，但这两种模式在Android4.2版本种都已经废弃了。因为Android官方已经不在推荐使用这种方式来实现跨程序共享的功能，而是应该使用更加安全可靠的内容提供器技术。

&emsp;&emsp;可能你会有些疑惑，为什么将我们程序的数据共享给其他程序呢？当然，这个是要视情况而定的，比如说账户和密码这样的隐私数据显然是不能给其他应用程序的，不过一些可以让其他程序进行二次开发的基础数据，我们还是可以选择将其共享的。例如系统的电话薄程序，它的数据库中保存了很多的联系人信息。如果这些数据都不允许第三方的程序进行访问的话，恐怕很多应用的功能都要大打折扣。除了电话薄之外，还有短信、媒体库等程序都实现了跨程序数据共享的功能，而使用的技术当然就是内容提供器了。

### 7.1 内容提供器简介

&emsp;&emsp;内容提供器(Content Provider)主要用于在不同的应用程序之间实现数据共享的功能，它提供了一套完整的机制，允许一个程序访问另一个程序中的数据，同时还能保证被访问数据的安全性。目前，使用内容提供器是Android实现跨程序共享数据的标准方式。

&emsp;&emsp;不同于文件存储和SharedPreferences存储中的两种全局可读写操作模式，内容提供器可以选择只对那一部分数据进行共享，从而保证我们程序中的隐私数据不会有泄露的风险。

&emsp;&emsp;不过在正式学习内容提供器之前，我们需要先掌握另外一个非常重要的知识——Android运行时，因为待会的内容提供器示例中会使用到运行时权限。当然不光是内容提供器，以后我们的开发过程中也会经常使用到运行时权限，因此必须掌握它。

### 7.2 运行时权限

&emsp;&emsp;Android的权限机制并不是什么新鲜事物，从系统的第一个版本开始就已经存在了。但其实之前Android的权限机制在保护用户安全和隐私等方面起到的作用比较有限，尤其是大家都离不开的常用软件，非常容易“店大欺客”。为此，Android开发团队在Android 6.0 系统中引用了运行时权限这个功能，从而更好地保护了用户的安全和隐私，那么本节我们就来详细学习一下这个6.0系统中引入的新特性。

#### 7.2.1 Android权限机制详解

&emsp;&emsp;首先来回顾一下过去Android的权限机制是什么样的。我们在第5章些BroadcastTest项目的时候第一次接触了Android权限相关的内容，当时为了要访问系统的网络状态以及监听开机广播，于是在AndroidManifest.xml文件中添加了这样两句权限声明：

```
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"/>
    <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED"/>
```

&emsp;&emsp;因为访问系统的网络状态以及监听开机广播涉及了用户设备的安全性，因此必须在AndroidManifest.xml中加入权限声明后，否则我们的程序就会崩溃。那么问题来了，加入了这两句权限声明之后，对于用户来说到底有什么影响呢？为什么这样就可以保护用户设备的安全性了呢？其实用户主要在以下两个方面得到了保护，一方面，如果用户在低于6.0系统的设备上安装该程序，会在安装界面给出提醒。这样用户就可以清楚地知晓该程序一共申请了哪些权限，从而决定是否要安装这个程序。另一方面，用户可以随时在应用管理界面查看任意一个程序的权限申请情况。这样该程序申请的所有权限就尽收眼底，什么都瞒不过用户的眼睛，以此保证应用程序不会出现各种滥用权限的情况。这种权限机制的设计思路其实非常简单，就是用户如果认可你所申请的权限，那么就会安装你的程序，如果不认可你所申请的权限，那么拒绝安装就可以了。但是理想是美好的，现实却很残酷，因为很多我们所离不开的常用软件普遍存在着滥用权限的情况，不管到底用不用得到，反正先把权限申请了再说。  
&emsp;&emsp;Android开发团队也意识到了这个问题，于是在6.0系统中加入了运行时权限功能。也就是说，用户不需要在安装团建的时候一次性授权所有的申请权限，而是可以在软件的使用过程中再对某一权限申请进行授权。比如说一款相机应用在运行时申请了地理位置定位权限，就算我拒绝了这个权限，但是我应该仍然可以使用这个应用的其他功能，而不是像之前那样直接无法安装他们。  
&emsp;&emsp;当然，并不是所有权限都需要运行时申请，对于用户来说，不停地授权也很繁琐。Android现在将所有的权限归成两类，一类是普通权限，一类是危险权限。普通权限指的是那些不会直接威胁到用户的安全和隐私的权限，对于这部分权限申请，系统会自动帮我们进行授权，而不需要用户再去手动操作了，比如在BroadcastTest项目中申请的两个权限就是普通权限。危险权限则表示那些可能会触及用户隐私，或者对设备安全性造成影响的权限，如获取设备联系人信息，定位设备的地理位置等，对于这部分权限申请，必须由用户手动点击授权才可以，否则程序就无法使用相应的功能。