# 第14章 进入实战——开发酷欧天气

&emsp;&emsp;我们将要在本章中编写一个功能较为完整的天气预报程序，学习了这么就久的Android开发，现在终于到了考核验收的时候了。那么第一步我们需要给这个软件起个好听的名字，这里就叫它酷欧天气吧，英文名就叫做Cool Weather。确定好名字之后，下面就开始动手了。  

## 14.1 功能需求及技术可行性分析  
&emsp;&emsp;在开始编码之前，我们需要对程序进行需求分析，想一想酷欧天气中应该具备有哪些功能。将这些功能全部整理出来之后，我们才好动手去一一实现。这里我认为酷欧天气中至少应该具备以下功能：  
- 可以罗列出全国所有的省、市、县；
- 可以查看全国任意城市的天气信息；
- 可以自由地切换城市，去查看其他城市的天气；
- 提供手动刷新以及后台自动更新天气的功能。

&emsp;&emsp;虽然看上去只有4个主要的功能点，但如果想要全部实现这些功能却需要用到UI、网络、数据存储、服务等技术。因此还是非常考验你的综合应用能力的。不过好在这些技术在前面的章节中我们全部都学习过了，只要你学得用心，相信完成这些功能对于你来说并不难。  
&emsp;&emsp;分析完了需求之后，接下来就要进行技术可行性分析了。首先需要考虑的一个问题就是，我们如何才能得到全国省市县的数据信息，以及如何才能获取到每个城市的天气信息。比较遗憾的是，现在网上免费的天气预报接口已经越来越少，很多之前可以使用的接口都慢慢关闭掉了，包括本书第1版中使用的中国天气网的接口。因此，这次我也是特意用心去找了一些更加稳定的天气预报服务，比如彩云天气以及和风天气都非常不错。这两个天气预报服务虽说都是收费的，但它们每天都提供了一定次数的免费天气预报请求。那么简单起见，这里我们就使用和风天气来作为天气预报的数据来源，每天3000次的免费请求对于学习而言已经是相当充足了。  
&emsp;&emsp;解决了天气数据的问题，接下来还需要解决全国省市县数据的问题。同样，现在网上也没有一个稳定的接口可以使用，那么为了方便你的学习，我专门架设了一台服务器用于提供全国所有省市县的数据信息，从而帮你把道路都铺平了。  
&emsp;&emsp;那么下面我们来看一下这些接口的具体用法。比如想要罗列出中国所有的省份，只需要访问如下地址：  
> http://guolin.tech/api/china

&emsp;&emsp;服务器会返回我们一段JSON格式的数据，其中包含了中国所有省份名称以及省份id，如下所示：  
```json
[
  {
    "id": 1,
    "name": "北京"
  },
  {
    "id": 2,
    "name": "上海"
  },
  {
    "id": 3,
    "name": "天津"
  },
  {
    "id": 4,
    "name": "重庆"
  },
  {
    "id": 5,
    "name": "香港"
  },
  {
    "id": 6,
    "name": "澳门"
  },
  {
    "id": 7,
    "name": "台湾"
  },
  {
    "id": 8,
    "name": "黑龙江"
  },
  {
    "id": 9,
    "name": "吉林"
  },
  {
    "id": 10,
    "name": "辽宁"
  },
  {
    "id": 11,
    "name": "内蒙古"
  },
  {
    "id": 12,
    "name": "河北"
  },
  {
    "id": 13,
    "name": "河南"
  },
  {
    "id": 14,
    "name": "山西"
  },
  {
    "id": 15,
    "name": "山东"
  },
  {
    "id": 16,
    "name": "江苏"
  },
  {
    "id": 17,
    "name": "浙江"
  },
  {
    "id": 18,
    "name": "福建"
  },
  {
    "id": 19,
    "name": "江西"
  },
  {
    "id": 20,
    "name": "安徽"
  },
  {
    "id": 21,
    "name": "湖北"
  },
  {
    "id": 22,
    "name": "湖南"
  },
  {
    "id": 23,
    "name": "广东"
  },
  {
    "id": 24,
    "name": "广西"
  },
  {
    "id": 25,
    "name": "海南"
  },
  {
    "id": 26,
    "name": "贵州"
  },
  {
    "id": 27,
    "name": "云南"
  },
  {
    "id": 28,
    "name": "四川"
  },
  {
    "id": 29,
    "name": "西藏"
  },
  {
    "id": 30,
    "name": "陕西"
  },
  {
    "id": 31,
    "name": "宁夏"
  },
  {
    "id": 32,
    "name": "甘肃"
  },
  {
    "id": 33,
    "name": "青海"
  },
  {
    "id": 34,
    "name": "新疆"
  }
]
```
&emsp;&emsp;可以看到，这是一个JSON数组，数组中的每一个元素都代表着一个省份。其中，北京的id是1，上海的id是2。那么如何才能知道某个省内有哪些城市呢？其实也很简单，比如江苏的id是16，访问如下地址即可：  
> http://guolin.tech/api/china/16

&emsp;&emsp;也就是说，只需要将省份id添加到url地址的最后面就可以了，现在服务器返回的数据如下：  
```json
[
  {
    "id": 113,
    "name": "南京"
  },
  {
    "id": 114,
    "name": "无锡"
  },
  {
    "id": 115,
    "name": "镇江"
  },
  {
    "id": 116,
    "name": "苏州"
  },
  {
    "id": 117,
    "name": "南通"
  },
  {
    "id": 118,
    "name": "扬州"
  },
  {
    "id": 119,
    "name": "盐城"
  },
  {
    "id": 120,
    "name": "徐州"
  },
  {
    "id": 121,
    "name": "淮安"
  },
  {
    "id": 122,
    "name": "连云港"
  },
  {
    "id": 123,
    "name": "常州"
  },
  {
    "id": 124,
    "name": "泰州"
  },
  {
    "id": 125,
    "name": "宿迁"
  }
]
```
&emsp;&emsp;这样我们就得到江苏省内所有城市的信息了，可以看到，现在返回的数据格式和刚才查看省份信息时赶回的数据格式是一样的。相信此时你已经可以举一反三了，比如说苏州的id是116，那么想要知道苏州市下又有哪些县和区的时候，只需要访问如下地址：  
> http://guolin.tech/api/china/16/116

&emsp;&emsp;这次服务器返回的数据如下：

```json
[
  {
    "id": 937,
    "name": "苏州",
    "weather_id": "CN101190401"
  },
  {
    "id": 938,
    "name": "常熟",
    "weather_id": "CN101190402"
  },
  {
    "id": 939,
    "name": "张家港",
    "weather_id": "CN101190403"
  },
  {
    "id": 940,
    "name": "昆山",
    "weather_id": "CN101190404"
  },
  {
    "id": 941,
    "name": "吴中",
    "weather_id": "CN101190405"
  },
  {
    "id": 942,
    "name": "吴江",
    "weather_id": "CN101190407"
  },
  {
    "id": 943,
    "name": "太仓",
    "weather_id": "CN101190408"
  }
]
```
&emsp;&emsp;通过这种方式，我们就能把全国所有的省、市、县都罗列出来。那么解决了省市县数据的获取，我们又怎样才能查看到具体的天气信息呢？这就必须要用到每个地区对应的天气id了。观察上面返回的数据，你会发现每个县或区都会有一个weather_id，拿这个id再去访问对应的天气的接口，就能够获取到该地区具体的天气信息了。  
&emsp;&emsp;下面我们来看一下和风天气的接口该如何使用。首先你需要注册一个自己的账号，注册地址是http://guolin.tech/api/weather/register。注册好了之后使用这个账户登录，就能看到自己的API KEY，以及每天剩余的访问次数了。有了API KEY，再配合刚才的weather_id，我们就能获取到任意城市的天气信息了。比如说苏州的weather_id是CN101190401，那么访问如下接口即可查兰苏州的天气信息：  
> http://guolin.tech/api/weather?cityid=CN101190401&key=3906d8568ef8470d943c9765f5d891a8

&emsp;&emsp;返回的数据如下：

```json
{
  "HeWeather": [
    {
      "basic": {
        "cid": "CN101190401",
        "location": "苏州",
        "parent_city": "苏州",
        "admin_area": "江苏",
        "cnty": "中国",
        "lat": "26.07530212",
        "lon": "119.30623627",
        "tz": "+8.00",
        "city": "苏州",
        "id": "CN101190401",
        "update": {
          "loc": "2022-12-19 03:56",
          "utc": "2022-12-19 03:56"
        }
      },
      "update": {
        "loc": "2022-12-19 03:56",
        "utc": "2022-12-19 03:56"
      },
      "status": "ok",
      "now": {
        "cloud": "99",
        "cond_code": "104",
        "cond_txt": "阴",
        "fl": "16",
        "hum": "84",
        "pcpn": "0.0",
        "pres": "1012",
        "tmp": "17",
        "vis": "6",
        "wind_deg": "155",
        "wind_dir": "东南风",
        "wind_sc": "3",
        "wind_spd": "12",
        "cond": {
          "code": "104",
          "txt": "阴"
        }
      },
      "daily_forecast": [
        {
          "date": "2022-12-20",
          "cond": {
            "txt_d": "中雨"
          },
          "tmp": {
            "max": "20",
            "min": "15"
          }
        },
        {
          "date": "2022-12-21",
          "cond": {
            "txt_d": "多云"
          },
          "tmp": {
            "max": "27",
            "min": "14"
          }
        },
        {
          "date": "2022-12-22",
          "cond": {
            "txt_d": "阴"
          },
          "tmp": {
            "max": "17",
            "min": "10"
          }
        },
        {
          "date": "2022-12-23",
          "cond": {
            "txt_d": "阵雨"
          },
          "tmp": {
            "max": "25",
            "min": "15"
          }
        },
        {
          "date": "2022-12-24",
          "cond": {
            "txt_d": "多云"
          },
          "tmp": {
            "max": "27",
            "min": "14"
          }
        },
        {
          "date": "2022-12-25",
          "cond": {
            "txt_d": "阴"
          },
          "tmp": {
            "max": "28",
            "min": "10"
          }
        }
      ],
      "aqi": {
        "city": {
          "aqi": "59",
          "pm25": "32",
          "qlty": "良"
        }
      },
      "suggestion": {
        "comf": {
          "type": "comf",
          "brf": "舒适",
          "txt": "白天不太热也不太冷，风力不大，相信您在这样的天气条件下，应会感到比较清爽和舒适。"
        },
        "sport": {
          "type": "sport",
          "brf": "较不宜",
          "txt": "有较强降水，建议您选择在室内进行健身休闲运动。"
        },
        "cw": {
          "type": "cw",
          "brf": "不宜",
          "txt": "不宜洗车，未来24小时内有雨，如果在此期间洗车，雨水和路上的泥水可能会再次弄脏您的爱车。"
        }
      },
      "msg": "所有天气数据均为模拟数据，仅用作学习目的使用，请勿当作真实的天气预报软件来使用。"
    }
  ]
}
```

&emsp;&emsp;所有天气数据均为模拟数据，仅用作学习目的使用，请勿当作真实的天气预报软件来使用。返回数据的格式大体上就是这个样子，其中status代表请求的状态，ok表示成功。basic中包含城市的一些基本信息，aqi中会包含当前空气质量的情况，now中会包含当前的天气信息，suggestion中会包含一些天气相关的生活建议,daily_forecast中会包含未来几天的天气信息。访问http://guolin.tech/api/weather/doc这个网站可以查看更加详细的文档说明。  
&emsp;&emsp;数据都能获取到了之后，接下来就是JSON解析的工作了，这对于你来说应该很轻松了吧?确定了技术完全可行之后，接下来就可以开始编码了。至于将项目托管到github上这里就不赘述了。